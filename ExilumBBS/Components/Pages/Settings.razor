@page "/settings"
@using ExilumBBS.Services.SettingService
@using ExilumBBS.Services.ThemeService
@using ExilumBBS.State

@inject AppState appState
@inject UserState userState
@inject ITokenService tokenService
@inject IUserService userService
@inject IPopupService popupService
@inject IThemeService themeService
@inject ISettingService settingService
@inject NavigationManager navigation

@layout WithBackLayout

<MCellGroup>
    <MCellGroup Subheader="应用设置">
        <MCell Title="暗黑模式" Value="@_theme"></MCell>
    </MCellGroup>
    <MCellGroup Subheader="其他设置">
        @if (userState.IsLogin)
        {
            <MCell Title="退出登录" OnClick="Logout"></MCell>
        }
    </MCellGroup>
</MCellGroup>


@code {
    private string _theme = string.Empty;

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        // 设置AppBar标题

    }

    protected override async Task OnInitializedAsync()
    {
        appState.WithbackLayoutState.AppBarTitle = "设置";
        switch (settingService.GetTheme())
        {
            case ExilumBBS.Services.ThemeService.Theme.System:
                _theme = "跟随系统";
                break;
            case ExilumBBS.Services.ThemeService.Theme.Light:
                _theme = "浅色模式";
                break;
            default:
                _theme = "暗黑模式";
                break;
        }

        await base.OnInitializedAsync();
    }

    private async Task Logout()
    {
        var confirmed = await popupService.ConfirmAsync("退出登录", "您确定要退出当前账户吗?", AlertTypes.Warning);
        if (confirmed)
        {
            if (userState.Token != null)
            {
                await tokenService.DeleteTokenAsync(userState.Token);
            }

            if (userState.CurrentUserProfile != null)
            {
                await userService.DeleteUserProfile(userState.CurrentUserProfile.Uid);
            }

            navigation.NavigateTo("/");
        }
    }
}
