@page "/post/{Id:long}"

@layout WithBackLayout

@using System.Diagnostics
@using System.Text.Json
@using ExilumBBS.Components.Components
@using ExilumBBS.Components.Components.Toolbar.CommentBar
@using ExilumBBS.Components.Components.Popup
@using ExilumBBS.Models.DTO.Post
@using ExilumBBS.Models.Response
@using ExilumBBS.Models.Response.Post
@using ExilumBBS.State

@inject HttpTools httpTools
@inject NavigationManager navigationManager
@inject ITokenService tokenService
@inject IPopupService popupService
@inject INavigationService navigationService
@inject IJSRuntime js

@inject AppState appState

@if (postInfo != null && !string.IsNullOrEmpty(postInfo.Content))
{

    <MCard Class="overflow-auto"
           Style="margin: 0 auto;height: calc(100vh - 112px);"
           Id="infinite-scroll-usage">
        <MList dense>
            <MListItem>

                <MListItemContent>
                    <MListItemTitle class="d-flex align-center">
                        <MAvatar size="40" Class="mr-2">
                            <MImage Src="@postInfo.UserAvatar"></MImage>
                        </MAvatar>
                        <div class="topic-userinfo">
                            <div class="topic-userinfo-line1 align-center">
                                <span class="font-weight-medium">@postInfo.UserNickName</span>
                                <MChip Small
                                       Class="ml-2"
                                       Color="primary">
                                    @($"LV{postInfo.UserLevel}")
                                </MChip>
                                <MChip Small
                                       Class="ml-2"
                                       Color="primary">
                                    楼主
                                </MChip>
                                @if (postInfo.IsAdmin)
                                {
                                    <MChip Small
                                           Class="ml-2"
                                           Color="primary">
                                        官方
                                    </MChip>
                                }
                            </div>
                            <span class="text-caption text--secondary">
                                @postInfo.CreateTime @postInfo.IpLocation
                            </span>
                        </div>



                    </MListItemTitle>

                    <div class="mt-2 post-title">
                        @(postInfo.Title)
                    </div>
                    <div class="mt-2 post-content">
                        @((MarkupString)postInfo.Content)
                    </div>


                    <div class="d-flex align-center mt-2 mb-2">
                        <MButton Icon
                                 Size="small"
                                 Color="@(postInfo.IsLike ? "primary" : "default")"
                                 OnClick="() => ToggleTopicLike(postInfo)">
                            <MIcon>@(postInfo.IsLike ? "mdi-thumb-up" : "mdi-thumb-up-outline")</MIcon>
                        </MButton>
                        <span class="text-caption text--secondary ml-1">@postInfo.LikeNum</span>

                        <MButton Icon
                                 Size="small"
                                 Color="@(postInfo.IsBad ? "primary" : "default")"
                                 OnClick="() => ToggleTopicBad(postInfo)">
                            <MIcon>@(postInfo.IsBad ? "mdi-thumb-down" : "mdi-thumb-down-outline")</MIcon>
                        </MButton>

                        <MButton Icon
                                 Size="small"
                                 Class="ml-3"
                                 OnClick="() => NewCommentIsVisable=true">
                            <MIcon>mdi-comment-processing-outline</MIcon>
                        </MButton>
                        <span class="text-caption text--secondary ml-1">@postInfo.CommentNum</span>
                    </div>
                </MListItemContent>
            </MListItem>

            <MDivider />
        </MList>

        <div class="post-comment-header" id="post-comment">
            <MSubheader>评论(@postInfo.CommentNum)</MSubheader>
            <div class="post-comment-header-toolbar">
                <span class="@(Sort == 0 ? "post-comment-header-toolbar-item-active" : "")" @onclick="() => SwitchSortType(0)">默认</span>
                <span class="@(Sort == 1 ? "post-comment-header-toolbar-item-active" : "")" @onclick="() => SwitchSortType(1)">最早</span>
                <span class="@(Sort == 2 ? "post-comment-header-toolbar-item-active" : "")" @onclick="() => SwitchSortType(2)">最新</span>
            </div>
        </div>

        @if (commentList.Count > 0)
        {
            <Comment Comments="commentList" TopicId="Id">

            </Comment>
        }

        <MInfiniteScroll OnLoad="@CommentOnLoad"
                         Parent="#infinite-scroll-usage">
        </MInfiniteScroll>
    </MCard>
    <CommentBar ToggleLike="() => ToggleTopicLike(postInfo)"
                ToggleDisLike="() => ToggleTopicBad(postInfo)"
                NewComment="() => NewCommentIsVisable=true"
                IsLike="postInfo.IsLike"
                IsDisLike="postInfo.IsBad"
                LikeNum="postInfo.LikeNum"
                CommentNum="postInfo.CommentNum"
                ToComment="()=>ToComment()" />

    <CommentPopup @bind-Visible="NewCommentIsVisable" @ref="commentPopup" SendComment="() => SendComment()">
        <EditorContent>

        </EditorContent>
    </CommentPopup>

}


@code {
    [Parameter]
    public long Id { get; set; }

    private PostInfoResponse? postInfo;
    private List<CommentResponse> commentList = [];
    private PostCommentFilterDTO? filterDTO;

    private CommentPopup? commentPopup;

    private IJSObjectReference jsTools = default!;

    /// <summary>
    /// 发布新评论面板是否可见
    /// </summary>
    private bool NewCommentIsVisable { get; set; }

    /// <summary>
    /// 是否只看楼主
    /// </summary>
    private bool OnlyAuthor { get; set; }
    /// <summary>
    /// 排序方式
    /// </summary>
    private int Sort { get; set; } = 0;
    /// <summary>
    /// 是否还有下一页
    /// </summary>
    private bool NextPage { get; set; } = true;

    /// <summary>
    /// 跳转到评论区
    /// </summary>
    /// <returns></returns>
    private async Task ToComment()
    {
        await jsTools.InvokeVoidAsync("scrollToIdContainer", "post-comment");
    }

    /// <summary>
    /// 获取帖子主体信息
    /// </summary>
    /// <returns></returns>
    private async Task GetTopicInfo()
    {
        Debug.WriteLine($"获取帖子{Id}的信息");
        var response = await httpTools.GetAsync($"/community/topic/{Id}");
        if (response != null && response.Code == 0 && response.Data != null)
        {
            var post = response.Data.Value.Deserialize<PostInfoResponse>();
            postInfo = post;
        }
        else if (response != null)
        {
            //此处应为获取失败后错误处理
            await popupService.EnqueueSnackbarAsync(response.Message, AlertTypes.Error);
        }
    }

    /// <summary>
    /// 触底加载
    /// </summary>
    /// <param name="args"></param>
    /// <returns></returns>
    private async Task CommentOnLoad(InfiniteScrollLoadEventArgs args)
    {
        await PostTopicCommentList();
        args.Status = NextPage == false ? InfiniteScrollLoadStatus.Empty : InfiniteScrollLoadStatus.Ok;
    }

    /// <summary>
    /// 获取帖子评论
    /// </summary>
    /// <returns></returns>
    private async Task PostTopicCommentList()
    {
        Debug.WriteLine($"获取帖子{Id}的评论");

        if (NextPage == true)
        {
            if (filterDTO == null)
            {
                filterDTO = new PostCommentFilterDTO()
                {
                    TopicId = Id
                };
            }

            //设置查询DTO参数
            filterDTO.OnlyAuthor = this.OnlyAuthor;
            filterDTO.Sort = this.Sort;

            var response = await httpTools.PostAsync($"/community/comment/list", filterDTO);

            if (response != null && response.Code == 0 && response.Data != null)
            {
                var postList = response.Data.Value.Deserialize<CommentPageListResponse>();
                if (postList != null)
                {
                    filterDTO.HotValue = postList.HotValue;
                    filterDTO.LastId = postList.LastId;
                    NextPage = postList.NextPage;
                    commentList.AddRange(postList.List);
                }
                else
                {
                    //评论获取失败后错误处理
                    await popupService.EnqueueSnackbarAsync("操作失败", AlertTypes.Error);
                }

            }
            else if (response != null)
            {
                //此处应为获取失败后错误处理
                await popupService.EnqueueSnackbarAsync(response.Message, AlertTypes.Error);
            }
            else
            {
                await popupService.EnqueueSnackbarAsync("系统错误", AlertTypes.Error);
            }
        }
    }

    /// <summary>
    /// 帖子点赞
    /// </summary>
    /// <param name="postInfoResponse"></param>
    /// <returns></returns>
    private async Task ToggleTopicLike(PostInfoResponse postInfoResponse)
    {
        // 判断登录状态
        if (await tokenService.GetTokenAsync() == null)
        {
            await popupService.EnqueueSnackbarAsync("请先登录", AlertTypes.Warning);
            return;
        }

        var response = await httpTools.GetAsync($"/community/topic/like/{postInfoResponse.TopicId}");
        if (response != null && response.Code == 0)
        {
            if (postInfoResponse.IsLike)
            {
                // 再点一次是取消点赞
                await popupService.EnqueueSnackbarAsync("取消点赞");
            }
            else
            {
                await popupService.EnqueueSnackbarAsync("点赞成功");
            }
            Debug.WriteLine("点赞成功");
            await GetTopicInfo();
        }
    }

    /// <summary>
    /// 点踩
    /// </summary>
    /// <param name="postInfoResponse"></param>
    /// <returns></returns>
    private async Task ToggleTopicBad(PostInfoResponse postInfoResponse)
    {
        // 判断登录状态
        if (await tokenService.GetTokenAsync() == null)
        {
            Debug.WriteLine("请先登录");
            await popupService.EnqueueSnackbarAsync("请先登陆", AlertTypes.Warning);
            return;
        }

        var response = await httpTools.GetAsync($"/community/topic/bad/{postInfoResponse.TopicId}");
        if (response != null && response.Code == 0)
        {
            if (postInfoResponse.IsBad)
            {
                // 再点一次是取消点赞
                await popupService.EnqueueSnackbarAsync("取消点踩");
            }
            else
            {
                await popupService.EnqueueSnackbarAsync("点踩成功");
            }
            Debug.WriteLine("点踩成功");
            await GetTopicInfo();
        }
    }

    /// <summary>
    /// 切换排序模式
    /// </summary>
    /// <param name="type"></param>
    /// <returns></returns>
    private async Task SwitchSortType(int type)
    {
        this.Sort = type;
        filterDTO = null;
        NextPage = true;
        commentList = [];
        await PostTopicCommentList();
    }

    /// <summary>
    /// 发送评论
    /// </summary>
    /// <returns></returns>
    private async Task SendComment()
    {
        if (commentPopup != null && postInfo != null)
        {
            var htmlContent = await commentPopup.GetHTMLContent();

            Debug.WriteLine(htmlContent);
            var response = await httpTools.PostAsync("/community/comment/reply", new
            {
                code = "",
                comment_id = 0,
                comment_sub_id = 0,
                content = htmlContent,
                topic_id = postInfo.TopicId
            });

            if (response != null && response.Code == 0 && response.Data.HasValue)
            {
                NewCommentIsVisable = false;
                popupService.ShowSuccessToast("发送成功");
                if (postInfo.CommentNum is int num)
                {
                    postInfo.CommentNum = num + 1;
                }

                // 按最新模式重新加载评论
                await SwitchSortType(2);
                await jsTools.InvokeVoidAsync("scrollToIdContainer", "post-comment");
            }
        }

    }

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        await GetTopicInfo();
        await PostTopicCommentList();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // 导入JS工具类
            jsTools = await js.InvokeAsync<IJSObjectReference>("import", "./js/jstools.js");
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    protected override Task OnInitializedAsync()
    {
        navigationService.Initialize(navigationManager);
        appState.WithbackLayoutState.AppBarTitle = "帖子";
        return base.OnInitializedAsync();
    }
}
